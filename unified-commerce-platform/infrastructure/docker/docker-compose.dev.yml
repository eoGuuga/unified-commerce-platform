# AMBIENTE DE DESENVOLVIMENTO
# =============================
# Ambiente separado para desenvolvimento e testes
# - Portas diferentes da produção
# - Banco de dados separado
# - Configurações de dev

version: '3.8'

services:
  # BANCO DE DADOS - DEV
  ucm-postgres-dev:
    image: postgres:15-alpine
    container_name: ucm-postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: ucm_dev
      POSTGRES_USER: ucm_dev
      POSTGRES_PASSWORD: dev_password_2026
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./scripts/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"  # Porta diferente da produção (5433)
    networks:
      - ucm-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ucm_dev -d ucm_dev"]
      interval: 10s
      timeout: 5s
      retries: 5

  # REDIS - DEV
  ucm-redis-dev:
    image: redis:7-alpine
    container_name: ucm-redis-dev
    restart: unless-stopped
    ports:
      - "6380:6379"  # Porta diferente da produção (6380)
    networks:
      - ucm-dev-network
    volumes:
      - redis_dev_data:/data
    command: redis-server --appendonly yes

  # BACKEND - DEV (Hot Reload)
  ucm-backend-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: ucm-backend-dev
    restart: unless-stopped
    ports:
      - "3002:3001"  # Porta diferente da produção (3002)
    environment:
      # Configurações de Desenvolvimento
      NODE_ENV: development
      PORT: 3001

      # Banco DEV
      DB_HOST: ucm-postgres-dev
      DB_PORT: 5432
      DB_USERNAME: ucm_dev
      DB_PASSWORD: dev_password_2026
      DB_DATABASE: ucm_dev

      # Redis DEV
      REDIS_HOST: ucm-redis-dev
      REDIS_PORT: 6379

      # JWT DEV (mais simples)
      JWT_SECRET: dev_jwt_secret_2026_simple

      # Mercado Pago DEV (sandbox)
      MERCADOPAGO_ACCESS_TOKEN: ${MERCADOPAGO_ACCESS_TOKEN_SANDBOX}
      MERCADOPAGO_PUBLIC_KEY: ${MERCADOPAGO_PUBLIC_KEY_SANDBOX}

      # Ollama DEV
      OLLAMA_URL: http://host.docker.internal:11434

      # WhatsApp DEV (simulado)
      WHATSAPP_PROVIDER: mock

      # CORS DEV (mais permissivo)
      CORS_ORIGIN: "*"

      # Tenant DEV
      DEFAULT_TENANT_ID: dev-tenant-001
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      ucm-postgres-dev:
        condition: service_healthy
      ucm-redis-dev:
        condition: service_started
    networks:
      - ucm-dev-network
    command: npm run start:dev

  # FRONTEND - DEV (Next.js Hot Reload)
  ucm-frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: ucm-frontend-dev
    restart: unless-stopped
    ports:
      - "3003:3000"  # Porta diferente da produção (3003)
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3002/api/v1
      NEXT_PUBLIC_ENVIRONMENT: development
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - ucm-backend-dev
    networks:
      - ucm-dev-network
    command: npm run dev

  # OLLAMA - DEV (IA Local)
  ollama-dev:
    image: ollama/ollama:latest
    container_name: ollama-dev
    restart: unless-stopped
    ports:
      - "11435:11434"  # Porta diferente da produção (11435)
    volumes:
      - ollama_dev_data:/root/.ollama
    networks:
      - ucm-dev-network
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    # Modelo Llama 2 será baixado automaticamente na primeira execução

volumes:
  postgres_dev_data:
    driver: local
  redis_dev_data:
    driver: local
  ollama_dev_data:
    driver: local

networks:
  ucm-dev-network:
    driver: bridge
    name: ucm-dev-network